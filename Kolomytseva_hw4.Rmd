---
title: "Kolomytseva_hw4"
output: html_document
date: "2024-03-18"
---

# ДЗ 4. Расчет описательных статистик

# Коломыцева Анна

Загрузка библиотек

```{r echo: false}
library(tidyverse)
```

## Задание 1

Рассмотрим следующую статистическую гипотезу:

Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией.

Задайте seed для воспроизводимости результатов. Задайте размер выборки. Задайте значение среднего артериального (систолического) давления до приема нового препарата и после.

```{r}
set.seed(757)
sample_size <- 30
BP_before <- rnorm(n = sample_size, mean = 145, sd = 5)
BP_after <- rnorm(n = sample_size, mean = 120, sd = 5)
```

-   Сформулируйте нулевую и альтернативную гипотезы.
-   Определите уровень значимости.

```{r}
H0 <- "нет значимой разницы между давлением до приема препарата и после"
Ha <- "давление после приема препарата значимо меньше, чем до"
alpha <- 0.05
```

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

Требуется сравнить две выборки непрерывных нормально распределеннных данных, дисперсии признаков в выборках равны. Для этого предназначен двухвыборочный t-тест.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

```{r}
res <- t.test(BP_before, BP_after)
sprintf("наблюдаемое значение t-статистики = %.3f", res$statistic)
t_crit <- qt(p=alpha, df=res$parameter, lower.tail=FALSE)
sprintf("критическое значение t-статистики = %.3f", t_crit)
sprintf("P-value = %.2f", res$p.value)

if (res$p.value < alpha){
  print(Ha)
}else{
  print(H0)
}
```

-   Оцените и прокомментируйте статистическую значимость.

Наблюдаемое значение t-статистики значительно превышает критическое значение на заданном уровне значимости. P-значение намного меньше стандартного порога $\alpha=0.05$, что указывает на статистическую значимость результата. Таким образом отвергаем нулевую гипотезу, принимаем альтернативную: давление после приема препарата значимо меньше, чем до.

## Задание 2

Рассмотрим следующую статистическую гипотезу:

Существует некоторая связь между курением и развитием рака легких. 
Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих — 0.2
Рассмотрите два случая: для выборки размером 100 и выборки размером 30. Сгенерируйте данные по курению с помощью функции rep(), пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1.

```{r}
sample_size1 <- 100
sample_size2 <- 30
set.seed(757)

generate_dataset <- function(n) {
  smokers <- rep(c(TRUE, FALSE), each = n/2)
  # Генерация случаев рака легких для курящих
  cancer_in_smokers <- sample(c(TRUE, FALSE), size = n/2, 
                              prob = c(0.8, 0.2), replace = TRUE)
  
  # Генерация случаев рака легких для некурящих
  cancer_in_nonsmokers <- sample(c(TRUE, FALSE), size = n/2, 
                                 prob = c(0.2, 0.8), replace = TRUE)
  
  # Сборка датасета
  return(data.frame(
    smoker = smokers,
    lung_cancer = c(cancer_in_smokers, cancer_in_nonsmokers)))
}

dataset1 <- generate_dataset(sample_size1)
dataset2 <- generate_dataset(sample_size2)
```

-   Сформулируйте нулевую и альтернативную гипотезы.
-   Определите уровень значимости.

```{r}
H0 <- "нет значимой связи между курением и развитием рака легких, заболеваемоть одинакова у курящих и некурящих"
Ha <- "есть статистически значимая связь между курением и развитием рака легких"
alpha <- 0.05
```

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

Значимость различий между фактическим (выявленным в результате исследования) количеством качественных характеристик выборки, попадающих в каждую категорию, и теоретическим количеством (по нулевой гипотезе) позволяют оценить критерий хи-квадрат и точный критерий Фишера. 
Однако критерий хи-квадрат исправно работает только в случае, когда количество всех частот превышает 50, а минимальное ожидаемое значение для каждой группы не меньше 5 (на практике часто используют порог в 10 значений). Тест Фишера — точный, и поэтому может использоваться независимо от особенностей выборки. Он позволяет получать более аккуратный анализ для маленьких выборок или данных, которые редки.

С учетом рамеров выборок, для первой используем критерий хи-квадрат, а для второй - точный критерий Фишера.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

```{r}
# выборка 1
# Создание таблицы сопряженности
table_data1 <- table(dataset1$smoker, dataset1$lung_cancer)
dimnames(table_data1) <- list(
  Smoking_Status = c("Non-Smoker", "Smoker"),
  Lung_Cancer = c("No", "Yes"))
table_data1

res_chi <- chisq.test(table_data1)
sprintf("наблюдаемое значение статистики хи-квадрат = %.3f", res_chi$statistic)
t_crit <- qchisq(p=alpha, df=res_chi$parameter, lower.tail=FALSE)
sprintf("критическое значение статистики хи-квадрат = %.3f", t_crit)
sprintf("P-value критерия хи-квадрат = %.3f", res_chi$p.value)

if (res_chi$p.value < alpha){
  print(Ha)
}else{
  print(H0)
}

# выборка 2
table_data2 <- table(dataset2$smoker, dataset2$lung_cancer)
dimnames(table_data2) <- list(
  Smoking_Status = c("Non-Smoker", "Smoker"),
  Lung_Cancer = c("No", "Yes"))
table_data2

res_fisher <- fisher.test(table_data2)
sprintf("P-value теста Фишера = %.3f", res_fisher$p.value)
if (res_fisher$p.value < alpha){
  print(Ha)
}else{
  print(H0)
}
```
-   Оцените и прокомментируйте статистическую значимость.

Для первой выборки размером 100 тест хи-квадрат показал значение статистики большее, чем критисекое, а также значение p близко к 0 (много меньше $\alpha=0.05$), следовательно результаты теста статистически значимы: есть статистически значимая связь между курением и развитием рака легких.

Для второй выборки размером 30 использовали тест Фишера. В отличие от теста Хи-квадрат, точный тест Фишера не содержит статистики тестирования для отчета. Вместо этого выводим p-значение теста: оно много меньше $\alpha=0.05$, что говорит о наличии статистической значимости.
Можно также обратить внимание на отношение шансов и его 95% доверительный интервал:
```{r}
res_fisher$estimate
res_fisher$conf.int[1:2]
```
Число 1 не входит в пределы этого отношения, это подтверждает, альтернативную гипотезу: есть статистически значимая связь между курением и развитием рака легких.

## Задание 3

Рассмотрим следующую статистическую гипотезу:

Применение нового метода лечения синдрома раздраженного кишечника значимо меняет уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией.

Исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение.

```{r}
set.seed(757)

new <- runif(n=30, min=0, max=4)
diets <- runif(n=30, min=2, max=6)
```

-   Сформулируйте нулевую и альтернативную гипотезы.
-   Определите уровень значимости.

```{r}
H0 <- "нет значимой разницы в уровне болевых симптомов между новым методом и диетотерапией"
Ha <- "есть статистически значимая разница: новый метод лечения значимо меняет уровень болевых симптомов по сравнению с диетотерапией"
alpha <- 0.05
```

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

В исследовании нет допущений о нормальности распределения. Две выборки независимы и имеют одинаковое распределение. Следовательно, для провеки статистической значимости подойдет тест Манна-Уитни. Он считается непараметрическим эквивалентом двухвыборочного независимого t-критерия.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

```{r}
res <- wilcox.test(new, diets, alternative="less")
sprintf("наблюдаемое значение U-статистики = %.f", res$statistic)
W_crit <- 338 # для выборок размерами по 30 и alpha=0.05
# https://koi.tspu.ru/biostat/Mann-Whitney%20statistics.pdf
sprintf("критическое значение U-статистики = %.f", W_crit)
sprintf("P-value критерия хи-квадрат = %.3f", res$p.value)
if (res$p.value < alpha){
  print(Ha)
}else{
  print(H0)
}
```
-   Оцените и прокомментируйте статистическую значимость.

Поскольку тестовая статистика меньше критического значения, а p-значение много меньше $\alpha=0.05$, то отвергаем нулевую гипотезу. Делаем вывод, что есть статистически значимая разница: новый метод лечения значимо меняет уровень болевых симптомов по сравнению с диетотерапией.

## Задание 4

Рассмотрим следующую гипотезу:

Проводится исследование, в котором исследуются три противоопухолевые препарата A, B плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей.  Оценивается размер опухоли у мыши.

Сгенерируем датасет:

```{r}
tumor <- tibble(
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))
tumor$value <- tumor$value + rnorm(30, 0, 760)
tumor
```

Построим на одном графике три boxplot:
```{r}
tumor %>% 
  ggplot(aes(therapy, value, fill=therapy)) +
  geom_boxplot() +
  theme_bw() +
  labs(title = "Зависимость размера опухоли от препарата",
      x = "противоопухолевые препараты (плацебо, A, B)",
      y = "размер опухоли у мыши")
```
-   Сформулируйте нулевую и альтернативную гипотезы.
-   Определите уровень значимости.

```{r}
H0 <- "нет значимой разницы в размере опухоли между противоопухолевыми препаратами (плацебо, A, B)"
Ha <- "есть статистически значимая разница между противоопухолевыми препаратами (плацебо, A, B)"
alpha <- 0.05
```

-   Проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах. Прокомментируйте получившийся результат.

```{r}
anova <- aov(value ~ therapy, data = tumor)
summary(anova)
```
P-value по результатам дисперсионного анализа меньше $\alpha=0.05$, поэтому можно сказать, что есть значимая разница между противоопухолевыми препаратами (плацебо, A, B). Для уточнения какие именно группы различаются нужно провести попарные сравнения.

-   С помощью функции TukeyHSD() проведите попарные сравнения, используя критерий Тьюки.
Прокомментируйте полученные результаты.

```{r}
TukeyHSD(anova)
```
```{r}
# построим доверительные интервалы
fig <- plot(TukeyHSD(anova), las = 1)
```
По результатам прарных сравнений можно сказать, что есть значимая разница между препаратом А и плацебо и между B и плацебо, так как знаяение 0 не входит в доверителные интарвалы разности размеров опухоли для этих пар, а p-значение меньше $\alpha=0.05$.

Сравнение препаратов A и B с помощью критерия Тьюки показало, что доверительный интервал разности размеров опухоли включает 0, а p-значение превышает уровень значимости 0.05, то есть не можем отвергнуть нулевую гипотезу: нет значимой разницы в размере опухоли между противоопухолевыми препаратами A и B.


